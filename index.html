<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Точная карта провинций</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f0f0f0; }
        #map-container { position: relative; max-width: 1000px; margin: 0 auto; }
        #map-image { width: 100%; cursor: pointer; border: 1px solid #ccc; }
        #modal { 
            display: none; position: fixed; top: 0; left: 0; 
            width: 100%; height: 100%; background: rgba(0,0,0,0.8); 
            z-index: 100; align-items: center; justify-content: center;
        }
        .modal-content { 
            background: white; padding: 20px; width: 300px; 
            border-radius: 8px; box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        .color-preview { 
            display: inline-block; width: 20px; height: 20px; 
            border: 1px solid #000; vertical-align: middle;
        }
        button { 
            padding: 8px 15px; background: #4CAF50; 
            color: white; border: none; border-radius: 4px; 
            cursor: pointer; margin-top: 10px;
        }
    </style>
</head>
<body>
    <div id="map-container">
        <img id="map-image" src="map.jpeg" alt="Карта провинций">
        <div id="debug-info" style="margin-top: 10px; color: #666;"></div>
    </div>

    <div id="modal">
        <div class="modal-content">
            <h3>Информация о провинции</h3>
            <p><strong>ID:</strong> <span id="province-id">-</span></p>
            <p><strong>Владелец:</strong> <span id="province-owner">-</span></p>
            <p><strong>Цвет:</strong> <span id="province-color">-</span> 
               <span id="color-preview" class="color-preview"></span></p>
            <button onclick="closeModal()">Закрыть</button>
        </div>
    </div>

    <script>
        // Глобальные переменные
        const provinces = [];
        let maskLoaded = false;
        
        // Инициализация данных провинций
        function initProvinces() {
            for (let i = 1; i <= 484; i++) {
                const hex = i.toString(16).padStart(6, '0').toUpperCase();
                provinces.push({
                    id: i,
                    color: `#${hex}`,
                    owner: i <= 35 ? "Конвен" : "Terra Incognita"
                });
            }
        }
        
        // Загрузка маски
        function loadMask() {
            return new Promise((resolve, reject) => {
                const maskImage = new Image();
                maskImage.crossOrigin = "Anonymous";
                maskImage.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d', { willReadFrequently: true });
                    canvas.width = maskImage.width;
                    canvas.height = maskImage.height;
                    ctx.drawImage(maskImage, 0, 0);
                    
                    // Сохраняем canvas и ctx в глобальной области видимости
                    window.maskCanvas = canvas;
                    window.maskCtx = ctx;
                    maskLoaded = true;
                    resolve();
                };
                maskImage.onerror = reject;
                maskImage.src = 'mask.png?' + new Date().getTime(); // Добавляем timestamp для избежания кеширования
            });
        }
        
        // Функция для получения точного цвета
        function getExactProvinceId(x, y) {
            try {
                const pixelData = window.maskCtx.getImageData(x, y, 1, 1).data;
                const r = pixelData[0];
                const g = pixelData[1];
                const b = pixelData[2];
                
                // Преобразуем RGB в номер провинции
                // Учитываем, что цвета могут быть в формате #RRGGBB или #0000RR
                const provinceId1 = (r << 16) | (g << 8) | b;  // Полный RGB как число
                const provinceId2 = r;  // Только красный канал
                
                // Проверяем оба варианта
                const province1 = provinces.find(p => p.id === provinceId1);
                const province2 = provinces.find(p => p.id === provinceId2);
                
                return province1 || province2 || null;
            } catch (e) {
                console.error("Ошибка при получении цвета:", e);
                return null;
            }
        }
        
        // Отображение модального окна
        function showProvinceInfo(province, exactColor) {
            document.getElementById('province-id').textContent = province ? province.id : 'Неизвестно';
            document.getElementById('province-owner').textContent = province ? province.owner : 'Неизвестно';
            document.getElementById('province-color').textContent = exactColor;
            document.getElementById('color-preview').style.backgroundColor = exactColor;
            document.getElementById('modal').style.display = 'flex';
        }
        
        // Закрытие модального окна
        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }
        
        // Инициализация при загрузке страницы
        window.onload = async function() {
            initProvinces();
            try {
                await loadMask();
                document.getElementById('debug-info').textContent = "Маска успешно загружена. Кликните на карту.";
            } catch (e) {
                document.getElementById('debug-info').textContent = "Ошибка загрузки маски: " + e.message;
                document.getElementById('debug-info').style.color = "red";
            }
            
            // Обработчик клика по карте
            document.getElementById('map-image').addEventListener('click', function(e) {
                if (!maskLoaded) {
                    alert("Маска еще не загрузилась!");
                    return;
                }
                
                const rect = this.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                // Масштабируем координаты
                const scaleX = window.maskCanvas.width / rect.width;
                const scaleY = window.maskCanvas.height / rect.height;
                const maskX = Math.floor(x * scaleX);
                const maskY = Math.floor(y * scaleY);
                
                // Получаем точный цвет
                const pixelData = window.maskCtx.getImageData(maskX, maskY, 1, 1).data;
                const exactColor = `#${pixelData[0].toString(16).padStart(2, '0')}${pixelData[1].toString(16).padStart(2, '0')}${pixelData[2].toString(16).padStart(2, '0')}`.toUpperCase();
                
                // Пытаемся определить провинцию двумя способами
                const province1 = provinces.find(p => p.color === exactColor);
                const province2 = provinces.find(p => p.id === pixelData[0]); // Проверяем только красный канал
                
                // Выводим отладочную информацию
                console.log(`Координаты: ${maskX},${maskY} | Цвет: ${exactColor} | R:${pixelData[0]} G:${pixelData[1]} B:${pixelData[2]}`);
                
                // Показываем информацию о провинции
                showProvinceInfo(province1 || province2, exactColor);
            });
        };
    </script>
</body>
</html>
