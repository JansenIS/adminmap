# /etc/nginx/sites-available/adminmap.conf
# Safe baseline: gzip always on; optional brotli include if module is installed.

server {
    listen 80;
    server_name _;

    root /opt/adminmap;
    index index.html;

    # PHP entrypoint for api/*.php and legacy endpoints.
    location ~ \.php$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/run/php/php8.2-fpm.sock;
    }

    # Canonical aliases previously implemented via Apache rewrite.
    location ~ ^/api/provinces/([0-9]+)/?$ {
        rewrite ^ /api/provinces/show/index.php?pid=$1 last;
    }
    location ~ ^/api/realms/(kingdoms|great_houses|minor_houses|free_cities)/([^/]+)/?$ {
        rewrite ^ /api/realms/show/index.php?type=$1&id=$2 last;
    }
    location ~ ^/api/tiles/([0-9]+)/([0-9]+)/([0-9]+)/?$ {
        rewrite ^ /api/tiles/index.php?z=$1&x=$2&y=$3 last;
    }

    # gzip compression (production default)
    gzip on;
    gzip_vary on;
    gzip_comp_level 6;
    gzip_min_length 1024;
    gzip_proxied any;
    gzip_types
        application/json
        application/ld+json
        application/javascript
        application/xml
        image/svg+xml
        text/plain
        text/css
        text/javascript
        text/xml;

    # IMPORTANT: include only when nginx was built with ngx_brotli module.
    # Otherwise nginx -t will fail on unknown directives.
    # include /etc/nginx/snippets/adminmap-brotli.conf;

    location / {
        try_files $uri $uri/ =404;
    }
}
