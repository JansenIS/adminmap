# /etc/apache2/sites-available/adminmap.conf

<VirtualHost *:80>
    ServerName _default_
    DocumentRoot /opt/adminmap

    <Directory /opt/adminmap>
        AllowOverride All
        Require all granted
    </Directory>

    # Compression for API/static text payloads.
    <IfModule mod_headers.c>
        Header append Vary Accept-Encoding
    </IfModule>

    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE \
            application/json \
            application/ld+json \
            application/javascript \
            application/xml \
            image/svg+xml \
            text/plain \
            text/css \
            text/javascript \
            text/xml

        # Avoid recompressing pre-compressed/binary payloads.
        SetEnvIfNoCase Request_URI \
            "\.(?:gif|jpe?g|png|webp|avif|ico|zip|gz|bz2|rar|7z|woff2?)$" no-gzip
    </IfModule>

    <IfModule mod_brotli.c>
        BrotliCompressionQuality 5
        AddOutputFilterByType BROTLI_COMPRESS \
            application/json \
            application/ld+json \
            application/javascript \
            application/xml \
            image/svg+xml \
            text/plain \
            text/css \
            text/javascript \
            text/xml

        SetEnvIfNoCase Request_URI \
            "\.(?:gif|jpe?g|png|webp|avif|ico|zip|gz|bz2|rar|7z|woff2?)$" no-brotli
    </IfModule>

    # Canonical aliases for migrated API routes.
    RewriteEngine On
    RewriteRule ^/api/provinces/([0-9]+)/?$ /api/provinces/show/index.php?pid=$1 [L,QSA]
    RewriteRule ^/api/realms/(kingdoms|great_houses|minor_houses|free_cities)/([^/]+)/?$ /api/realms/show/index.php?type=$1&id=$2 [L,QSA]
    RewriteRule ^/api/tiles/([0-9]+)/([0-9]+)/([0-9]+)/?$ /api/tiles/index.php?z=$1&x=$2&y=$3 [L,QSA]

    ErrorLog ${APACHE_LOG_DIR}/adminmap_error.log
    CustomLog ${APACHE_LOG_DIR}/adminmap_access.log combined
</VirtualHost>
