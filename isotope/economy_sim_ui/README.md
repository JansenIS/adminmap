# Economy Simulator (Isotope / Lurra) — движок + локальный интерфейс

> Для развёртывания **всего monorepo adminmap** (основная карта + симулятор единым проектом) см. корневой `README.md` репозитория.

Это стартовый экономический симулятор под твою карту провинций (граф соседей/центроиды) и список товаров/производств из `Биржа.txt`.

Важно: это не «готовая игра», а базовый экономический слой, который:
- генерирует ресурсный потенциал по провинциям (в среднем у всех есть всё, но в разных количествах);
- гоняет производство/потребление/порчу;
- моделирует торговлю по графу провинций с логистической стоимостью;
- даёт динамику дефицита/профицита (через цены и запасы).

Дальше его нормализуют под канон: цепочки, нормы потребления, стартовая индустрия, роли городов, спец-ресурсы и т.д.

## Что внутри

- `engine.js` — симуляция: добыча → производство → потребление → торговля → цены.
- `resources.js` — каталог товаров и рецептов производств (включены **мутакурицы** и **мутабрюква**).
- `utils.js` — RNG + Dijkstra.
- `run_node.js` — консольный прогон.

Дополнительно:
- `server.js` + `public/` — локальный web-интерфейс (просмотр по провинциям: товары, запасы, цены, дефицит).
- `public/sim-admin.html` — отдельная админка симулятора с картой из adminmap (неоновые контуры + точки по метрикам).
- `START_VIEWER.bat` — быстрый запуск на Windows.

## 1) Быстрый запуск интерфейса (Windows)

Требования: Node.js 18+

Рекомендуемая структура:
- `C:\isotope\province_routing_data.json`
- `C:\isotope\economy_sim_ui\...` (эта папка)

Запуск:
1) Открой папку `economy_sim_ui`.
2) Дважды кликни `START_VIEWER.bat`.
3) Откроется браузер: `http://localhost:8787`

Если `province_routing_data.json` лежит в другом месте — открой `START_VIEWER.bat` и поправь строку `set DATA=...`.

## 2) Запуск интерфейса вручную (PowerShell)

```powershell
cd C:\isotope\economy_sim_ui
node .\server.js ..\province_routing_data.json --port 8787 --seed 1
```

## 3) Консольный прогон (как раньше)

```powershell
cd C:\isotope\economy_sim_ui
node .\run_node.js ..\province_routing_data.json --days 60 --seed 42
```

Снапшот в JSON:
```powershell
node .\run_node.js ..\province_routing_data.json --days 60 --seed 42 --snapshot true
```

## Как этим «взаимодействовать» и зачем

Сейчас это инструмент для трёх вещей:

1) **Проверить географию ресурсов.**
   Ты увидишь, что у каждой провинции есть выпуск сырья, но специализация разная. Это основа «экономической карты».

2) **Проверить, где рождаются дефициты.**
   Даже при «равном ожидании» дефицит появится из-за цепочек и логистики (дальние провинции/плохая инфра/низкая пропускная способность).

3) **Подготовить интеграцию с твоей картой.**
   Твой следующий шаг — отрисовать на карте слои (GDP, цены, наличие еды/фильтров/металлов) и дать игроку торговые решения.

То есть: симулятор = расчёт, интерфейс = инспектор. Игровой UI уже делается поверх этого (или поверх снапшотов).

## Что править в первую очередь

- `resources.js`: товары (bulk/rarity/decay), **рецепты производств**.
- `engine.js`: транспорт (стоимость/ёмкость), правила торгового мэтчинга, модель спроса/резервов.
- стартовая индустрия: распределение зданий/уровней по провинциям (сейчас это «скелет», чтобы экономика не умерла).


Дополнительно для админки симулятора:
- `GET /api/admin/map-sync` — объединённые данные adminmap + текущие сим-метрики по провинциям.
- `POST /api/admin/province` — сохранить оверрайды province-параметров (`pop`, `infra`, `gdpWeight`) в `data/sim_admin_overrides.json`.
- URL: `http://localhost:8787/sim-admin`

## 4) Установка всего репозитория на Linux-сервер

Ниже минимальная схема развёртывания **всего репозитория** `adminmap` + симулятора:

```bash
# 1) системные пакеты
sudo apt update
sudo apt install -y git curl

# 2) Node.js 20 LTS
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt install -y nodejs

# 3) клонирование репозитория
cd /opt
sudo git clone <URL_ВАШЕГО_РЕПО> adminmap
sudo chown -R $USER:$USER /opt/adminmap
cd /opt/adminmap/isotope/economy_sim_ui

# 4) запуск симулятора
node ./server.js ../province_routing_data.json --port 8787
```

Проверка:

```bash
curl -s http://127.0.0.1:8787/api/summary
curl -s http://127.0.0.1:8787/api/admin/map-sync
```

Открыть в браузере:
- Viewer: `http://<SERVER_IP>:8787/`
- Админка симулятора: `http://<SERVER_IP>:8787/sim-admin`

Если нужен фоновый запуск после перезагрузки, добавь systemd unit для `node server.js ...`.
