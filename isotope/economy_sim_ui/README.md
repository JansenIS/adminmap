# Economy Simulator (PHP + SQLite)

Экономический симулятор для карты переведён на PHP (без Node.js сервера) и работает с **годовым шагом**.

## Что изменено

- API и веб-страница симулятора работают через PHP: `index.php` + `api.php` (восстановлен полный интерфейс инспектора: сводка, список провинций, фильтры товаров, торговый баланс, снапшот).
- Режим непрерывной симуляции убран: доступны только дискретные годовые шаги (`action=tick&years=N` / `action=step&years=N`).
- Статические данные (геометрия/соседи провинций) берутся из `isotope/province_routing_data.json`.
- Динамические данные берутся напрямую из основного проекта:
  - `data/map_state.json` — названия, владельцы, принадлежность к королевствам/домам и т.д.
  - `hexmap/data.js` — принадлежность гексов провинциям.
- У симулятора отдельная БД: `isotope/economy_sim_ui/storage/economy.sqlite`.
- В базовой конфигурации используется расширенный набор из 21 товара (сырьё/компоненты/продукты), а не 4 позиции.
- Файлы основного проекта не изменяются симулятором, чтение только read-only.

## Запуск

Из корня репозитория:

```bash
php -S 127.0.0.1:8787 -t isotope/economy_sim_ui
```

Открыть:

- http://127.0.0.1:8787/index.php

## API

- `api.php?action=summary` — сводка.
- `api.php?action=step&years=1` — выполнить годовой шаг (можно `years=10`).
- `api.php?action=province&pid=123` — детально по провинции.
- `api.php?action=reset` — сбросить экономическое состояние.

- `api.php?action=meta` — метаданные (провинции/товары/конфиг).
- `api.php?action=tick&years=1` — годовой шаг (совместимо с `step`).
- `api.php?action=trade-balance` — глобальный торговый баланс.
- `api.php?action=snapshot` — агрегированный снапшот.

- `admin_sim.php` — отдельная админ-страница симулятора с картой провинций и редактированием параметров (город/население/инфра/транспорт/GDP/здания) в отдельной БД симулятора.
- `api.php?action=admin-provinces` — список провинций для карты симулятора.
- `api.php?action=admin-province-save&pid=...` (POST JSON) — сохранить оверрайды параметров провинции и зданий.
- В `admin_sim.php` добавлены: контуры провинций, режимы покраски (Королевства / ВД / МД), аккуратная маркировка особых территорий (free city) без перезаливки режима, и прозрачный режим (кружки-центры + контуры) с выбором размера кружков по населению/ВВП/инфраструктуре/размеру провинции.
- В расчёт годового шага добавлен этап соседской межпровинциальной торговли по графу соседей (базовая логистика по shared_sides).
- Параметры `transportUnitCost` и `tradeFriction` теперь влияют на этап межпровинциальной торговли в годовом шаге (ограничение ёмкости и интенсивности потоков).
- Добавлен дополнительный этап условной внешней торговли (арбитраж с внешним рынком) после соседской торговли, чтобы продолжить перенос логики межрегиональных потоков.
- Добавлен этап провинциальных модификаторов производства/потребления (учёт city/pop/infra + влияние настраиваемых зданий).
- Добавлен промышленный граф на основе полного списка рецептов BUILDINGS (с применением доступных в текущей PHP-модели commodities) и отдельный логистический этап перераспределения по кратчайшим путям между провинциями.

## Не успел перенести (пока)

- Полная симуляция всех рецептов из `resources.js`/`BUILDINGS` с расширением самой commodity-модели до полного набора оригинала (сейчас граф рецептов загружен целиком, но в расчёт входят только товары, присутствующие в PHP commodity-модели).
- Полный min-cost flow/баланс потоков по графу для всех дефицитов/профицитов за шаг (сейчас есть shortest-path логистика + соседская торговля + внешний арбитраж, но без полноценного глобального оптимизатора потоков).
- Детальная модель внутренней/внешней торговли с ордерами, отдельными потоками экспорта/импорта и историей по сделкам.
- Полная деградация/порча и хранение запасов по типам складов/инфраструктуры (сейчас порча упрощённая по commodity decay).
- Экономический баланс с калибровкой на игровые параметры/сценарии и автотестами регрессии экономики.

- Для `admin_sim.php` добавлена нормализация масштабов гексов/центроидов и fit-вьюпорт, чтобы кружки и контуры корректно занимали весь экран в одном масштабе.
